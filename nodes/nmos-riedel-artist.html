<script type="text/javascript">
RED.nodes.registerType('nmos-riedel-artist',{
    category: 'NMOS',
    color: '#FFA07A',
    defaults: {
        name: {value:""},
        registry: {value:"", type:"nmos-config", required:true},
        mqttBroker: {value:"mqtt://localhost:1883", required:true},
        deviceLabel: {value:"RIEDEL Artist Panel"},
        deviceDescription: {value:"Artist intercom panel via NMOS"},
        panelLabel: {value:"Artist Panel"},
        panelType: {value:"generic"},
        mqttQos: {value:1},
        enableAudioRouting: {value:true},
        enableKeyControl: {value:true},
        matrixSourceId: {value:""},
        nodeId: {value:""},
        deviceId: {value:""},
        senderId: {value:""},
        receiverId: {value:""}
    },
    inputs:1,
    outputs:1,
    icon: "font-awesome/fa-sitemap",
    label: function() {
        return this.name || this.panelLabel || "RIEDEL Artist";
    },
    oneditprepare: function() {
        // Generate UUIDs if not present
        if (!this.nodeId) this.nodeId = generateUUID();
        if (!this.deviceId) this.deviceId = generateUUID();
        if (!this.senderId) this.senderId = generateUUID();
        if (!this.receiverId) this.receiverId = generateUUID();
        if (!this.matrixSourceId) this.matrixSourceId = generateUUID();
        
        $("#node-input-nodeId").val(this.nodeId);
        $("#node-input-deviceId").val(this.deviceId);
        $("#node-input-senderId").val(this.senderId);
        $("#node-input-receiverId").val(this.receiverId);
        $("#node-input-matrixSourceId").val(this.matrixSourceId);
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        $("#node-input-regenerate-ids").click(function() {
            $("#node-input-nodeId").val(generateUUID());
            $("#node-input-deviceId").val(generateUUID());
            $("#node-input-senderId").val(generateUUID());
            $("#node-input-receiverId").val(generateUUID());
            $("#node-input-matrixSourceId").val(generateUUID());
        });
    }
});
</script>

<script type="text/html" data-template-name="nmos-riedel-artist">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-registry"><i class="fa fa-server"></i> Registry</label>
        <input type="text" id="node-input-registry">
    </div>
    <div class="form-row">
        <label for="node-input-mqttBroker"><i class="fa fa-exchange"></i> MQTT Broker</label>
        <input type="text" id="node-input-mqttBroker" placeholder="mqtt://localhost:1883">
    </div>
    
    <hr/>
    <h4>Panel Configuration</h4>
    
    <div class="form-row">
        <label for="node-input-deviceLabel"><i class="fa fa-tag"></i> Device Label</label>
        <input type="text" id="node-input-deviceLabel">
    </div>
    <div class="form-row">
        <label for="node-input-deviceDescription"><i class="fa fa-info"></i> Description</label>
        <input type="text" id="node-input-deviceDescription">
    </div>
    <div class="form-row">
        <label for="node-input-panelLabel"><i class="fa fa-tag"></i> Panel Label</label>
        <input type="text" id="node-input-panelLabel">
    </div>
    <div class="form-row">
        <label for="node-input-panelType"><i class="fa fa-cog"></i> Panel Type</label>
        <select id="node-input-panelType">
            <option value="generic">Generic</option>
            <option value="1100">Artist 1100</option>
            <option value="2300">Artist 2300</option>
            <option value="smartpanel">Smartpanel</option>
        </select>
    </div>
    <div class="form-tip">
        <strong>Panel Type:</strong> Select the RIEDEL Artist panel model. Generic works with all types.
    </div>
    
    <hr/>
    <h4>Features</h4>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-enableKeyControl" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-enableKeyControl" style="width: 70%;">Enable Key Control</label>
    </div>
    <div class="form-tip">
        Enable panel key configuration and control (button assignments, talk/listen modes)
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-enableAudioRouting" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-enableAudioRouting" style="width: 70%;">Enable Audio Routing</label>
    </div>
    <div class="form-tip">
        Enable Artist matrix audio routing functionality (create/remove routes)
    </div>
    
    <hr/>
    <h4>MQTT Settings</h4>
    
    <div class="form-row">
        <label for="node-input-mqttQos"><i class="fa fa-certificate"></i> QoS Level</label>
        <select id="node-input-mqttQos">
            <option value="0">0 - At most once</option>
            <option value="1">1 - At least once</option>
            <option value="2">2 - Exactly once</option>
        </select>
    </div>
    
    <hr/>
    <h4>Resource IDs</h4>
    
    <div class="form-row">
        <label for="node-input-nodeId"><i class="fa fa-fingerprint"></i> Node ID</label>
        <input type="text" id="node-input-nodeId">
    </div>
    <div class="form-row">
        <label for="node-input-deviceId"><i class="fa fa-fingerprint"></i> Device ID</label>
        <input type="text" id="node-input-deviceId">
    </div>
    <div class="form-row">
        <label for="node-input-senderId"><i class="fa fa-fingerprint"></i> Sender ID</label>
        <input type="text" id="node-input-senderId">
    </div>
    <div class="form-row">
        <label for="node-input-receiverId"><i class="fa fa-fingerprint"></i> Receiver ID</label>
        <input type="text" id="node-input-receiverId">
    </div>
    <div class="form-row">
        <label for="node-input-matrixSourceId"><i class="fa fa-fingerprint"></i> Matrix Source ID</label>
        <input type="text" id="node-input-matrixSourceId">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <button type="button" id="node-input-regenerate-ids" class="red-ui-button">
            <i class="fa fa-refresh"></i> Regenerate All IDs
        </button>
    </div>
</script>

<script type="text/html" data-help-name="nmos-riedel-artist">
    <p>NMOS RIEDEL Artist node - Intercom matrix control and panel management via NMOS IS-04, IS-05, IS-07, and IS-12.</p>
    
    <h3>Overview</h3>
    <p>This node provides comprehensive integration with RIEDEL Artist intercom matrix systems. It enables panel registration, 
    key assignment configuration, audio routing control, and status monitoring through NMOS standards.</p>
    
    <h3>Features</h3>
    <ul>
        <li><strong>Panel Registration:</strong> Automatic IS-04 registration as NMOS sender/receiver</li>
        <li><strong>Key Control:</strong> Configure and control Artist panel keys (talk/listen/both modes)</li>
        <li><strong>Audio Routing:</strong> Create and manage audio routes in the Artist matrix</li>
        <li><strong>Status Monitoring:</strong> Track panel status, connections, and active routes</li>
        <li><strong>MQTT Integration:</strong> IS-07 event-based communication</li>
        <li><strong>Bidirectional Communication:</strong> Send and receive Artist commands</li>
        <li><strong>Command History:</strong> Track and query received commands</li>
    </ul>
    
    <h3>Configuration</h3>
    
    <h4>Panel Settings</h4>
    <ul>
        <li><strong>Device Label:</strong> Display name for this Artist panel device</li>
        <li><strong>Panel Label:</strong> Label for the Artist panel</li>
        <li><strong>Panel Type:</strong> Artist panel model (generic, 1100, 2300, smartpanel)</li>
    </ul>
    
    <h4>Features</h4>
    <ul>
        <li><strong>Enable Key Control:</strong> Allow key configuration and control operations</li>
        <li><strong>Enable Audio Routing:</strong> Allow audio route creation and management</li>
    </ul>
    
    <h4>MQTT Settings</h4>
    <ul>
        <li><strong>MQTT Broker:</strong> Broker URL for IS-07 events (e.g., mqtt://broker:1883)</li>
        <li><strong>QoS Level:</strong> MQTT quality of service (recommended: 1)</li>
    </ul>
    
    <h3>Input Actions</h3>
    
    <p><strong>Get Current State:</strong></p>
    <pre>msg.payload = { action: "get_state" };</pre>
    <p>Returns panel configuration, status, and statistics.</p>
    
    <p><strong>Configure Key:</strong></p>
    <pre>msg.payload = {
    action: "configure_key",
    key: 1,
    config: {
        label: "Director",
        type: "intercom",
        destination: "destination-id",
        color: "green",
        mode: "both",  // talk, listen, or both
        enabled: true
    }
};</pre>
    <p>Configure a key on the Artist panel with label, destination, and behavior.</p>
    
    <p><strong>Key Action:</strong></p>
    <pre>msg.payload = {
    action: "key_action",
    key: 1,
    actionType: "press",  // press, release, toggle
    pressed: true
};</pre>
    <p>Simulate or handle a key press/release action.</p>
    
    <p><strong>Create Audio Route:</strong></p>
    <pre>msg.payload = {
    action: "create_route",
    sourceId: "source-panel-id",
    destinationId: "dest-panel-id",
    config: {
        gain: 0.0,
        muted: false,
        mode: "both"  // talk, listen, or both
    }
};</pre>
    <p>Create an audio route in the Artist matrix between two endpoints.</p>
    
    <p><strong>Remove Audio Route:</strong></p>
    <pre>msg.payload = {
    action: "remove_route",
    sourceId: "source-panel-id",
    destinationId: "dest-panel-id"
};</pre>
    <p>Remove an existing audio route from the Artist matrix.</p>
    
    <p><strong>Get Keys:</strong></p>
    <pre>msg.payload = { action: "get_keys" };</pre>
    <p>Returns all configured keys.</p>
    
    <p><strong>Get Routes:</strong></p>
    <pre>msg.payload = { action: "get_routes" };</pre>
    <p>Returns all active audio routes.</p>
    
    <p><strong>Get Command History:</strong></p>
    <pre>msg.payload = {
    action: "get_command_history",
    limit: 10  // optional, default 10
};</pre>
    <p>Returns recent command history.</p>
    
    <p><strong>Update Panel Status:</strong></p>
    <pre>msg.payload = {
    action: "update_panel_status",
    status: {
        connected: true,
        custom_field: "value"
    }
};</pre>
    <p>Update panel status information and publish via MQTT.</p>
    
    <p><strong>Clear History/Keys/Routes:</strong></p>
    <pre>// Clear command history
msg.payload = { action: "clear_history" };

// Clear all key configurations
msg.payload = { action: "clear_keys" };

// Clear all audio routes
msg.payload = { action: "clear_routes" };</pre>
    
    <h3>Output Messages</h3>
    <p>The node outputs messages for received Artist commands via MQTT:</p>
    <pre>{
    "topic": "x-nmos/events/1.0/{source-id}/{type}",
    "payload": {
        // IS-07 grain message
    },
    "source_id": "source-uuid",
    "flow_id": "flow-uuid",
    "artist": {
        "device_id": "panel-device-uuid",
        "panel_label": "Artist Panel",
        "panel_type": "generic",
        "commands": [
            {
                "type": "key_action|audio_route|panel_register|matrix_config",
                "key": 1,
                "action": "press",
                "pressed": true,
                // Other command-specific fields
            }
        ]
    }
}</pre>
    
    <h3>Artist Command Patterns</h3>
    <p>The node automatically recognizes these Artist-specific MQTT event patterns:</p>
    <ul>
        <li><strong>Key Actions:</strong> <code>artist/key/N/press</code>, <code>artist/key/N/release</code>, <code>artist/key/N/toggle</code></li>
        <li><strong>Audio Routes:</strong> <code>artist/route/{source-id}/{destination-id}</code></li>
        <li><strong>Panel Registration:</strong> <code>artist/panel/register</code></li>
        <li><strong>Matrix Configuration:</strong> <code>artist/matrix/config</code>, <code>artist/matrix/inputs</code>, <code>artist/matrix/outputs</code></li>
    </ul>
    
    <h3>Integration with RIEDEL Artist</h3>
    <p>To integrate with RIEDEL Artist matrix system:</p>
    <ol>
        <li>Configure Artist to communicate via NMOS IS-07 events</li>
        <li>Set the MQTT broker URL to match your infrastructure</li>
        <li>Configure panel type to match your Artist hardware</li>
        <li>Enable key control and/or audio routing as needed</li>
        <li>Use the node to monitor Artist commands and control the matrix</li>
        <li>Create flows to automate routing based on panel key presses</li>
    </ol>
    
    <h3>Example Use Cases</h3>
    <ul>
        <li>Automated intercom routing based on production cues</li>
        <li>Panel key configuration for different show setups</li>
        <li>Integration with production automation systems</li>
        <li>Remote panel monitoring and control</li>
        <li>Matrix snapshot management and recall</li>
        <li>Custom key behavior and logic</li>
        <li>Integration with other NMOS devices (cameras, audio, etc.)</li>
    </ul>
    
    <h3>NMOS Integration</h3>
    <p>This node integrates with other NMOS specifications:</p>
    <ul>
        <li><strong>IS-04:</strong> Automatic registration of panel as sender/receiver</li>
        <li><strong>IS-05:</strong> Compatible with NMOS connection management</li>
        <li><strong>IS-07:</strong> Event-based communication via MQTT</li>
        <li><strong>IS-12:</strong> Can be controlled via NCP if needed</li>
    </ul>
    
    <h3>Best Practices</h3>
    <ul>
        <li>Use QoS level 1 or 2 for reliable Artist command delivery</li>
        <li>Configure key labels clearly for operator clarity</li>
        <li>Monitor command history to track operator actions</li>
        <li>Use audio routing to create dynamic intercom setups</li>
        <li>Combine with other NMOS nodes for comprehensive workflows</li>
        <li>Implement error handling for failed route creations</li>
        <li>Periodically clear history to manage memory usage</li>
    </ul>
    
    <h3>Troubleshooting</h3>
    <ul>
        <li><strong>Panel not registering:</strong> Check NMOS registry URL and connectivity</li>
        <li><strong>No MQTT messages:</strong> Verify broker URL and connectivity</li>
        <li><strong>Keys not working:</strong> Ensure "Enable Key Control" is checked</li>
        <li><strong>Routes failing:</strong> Ensure "Enable Audio Routing" is checked and IDs are correct</li>
        <li><strong>Commands not parsed:</strong> Check MQTT topic patterns match expected format</li>
    </ul>
    
    <h3>Reference</h3>
    <ul>
        <li>NMOS IS-04: <a href="https://specs.amwa.tv/is-04/" target="_blank">specs.amwa.tv/is-04/</a></li>
        <li>NMOS IS-05: <a href="https://specs.amwa.tv/is-05/" target="_blank">specs.amwa.tv/is-05/</a></li>
        <li>NMOS IS-07: <a href="https://specs.amwa.tv/is-07/" target="_blank">specs.amwa.tv/is-07/</a></li>
        <li>NMOS IS-12: <a href="https://specs.amwa.tv/is-12/" target="_blank">specs.amwa.tv/is-12/</a></li>
        <li>RIEDEL Artist: <a href="https://www.riedel.net/products/intercom-and-radio/" target="_blank">riedel.net/products/intercom-and-radio/</a></li>
    </ul>
</script>
