<script type="text/javascript">
RED.nodes.registerType('nmos-is07-endpoint',{
    category: 'NMOS',
    color: '#C7E9C0',
    defaults: {
        name: {value:""},
        registry: {value:"", type:"nmos-config", required:true},
        mqttBroker: {value:"mqtt://localhost:1883", required:true},
        deviceLabel: {value:"Node-RED IS-07 Endpoint"},
        deviceDescription: {value:"IS-07 Endpoint receiver"},
        receiverLabel: {value:"Endpoint Receiver"},
        subscriptionFilter: {value:"x-nmos/events/1.0/+/+"},
        mqttQos: {value:0},
        sendStatusUpdates: {value:true},
        parseSmartpanel: {value:true},
        statusSourceId: {value:""},
        nodeId: {value:""},
        deviceId: {value:""},
        receiverId: {value:""},
        smartpanelIp: {value:""},
        smartpanelPort: {value:0},
        displayMappings: {value:[]},
        controlMappings: {value:{}}
    },
    inputs:1,
    outputs:1,
    icon: "font-awesome/fa-download",
    label: function() {
        return this.name || this.deviceLabel || "IS-07 Endpoint";
    },
    oneditprepare: function() {
        var node = this;
        
        // Generate UUIDs if not present
        if (!this.nodeId) this.nodeId = generateUUID();
        if (!this.deviceId) this.deviceId = generateUUID();
        if (!this.receiverId) this.receiverId = generateUUID();
        if (!this.statusSourceId) this.statusSourceId = generateUUID();
        
        $("#node-input-nodeId").val(this.nodeId);
        $("#node-input-deviceId").val(this.deviceId);
        $("#node-input-receiverId").val(this.receiverId);
        $("#node-input-statusSourceId").val(this.statusSourceId);
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        $("#node-input-regenerate-ids").click(function() {
            $("#node-input-nodeId").val(generateUUID());
            $("#node-input-deviceId").val(generateUUID());
            $("#node-input-receiverId").val(generateUUID());
            $("#node-input-statusSourceId").val(generateUUID());
        });
        
        // Initialize display mappings
        if (!node.displayMappings) {
            node.displayMappings = [];
        }
        
        // Display mappings list
        var displayList = $("#node-input-display-container");
        
        function addDisplayMapping(name, id) {
            var row = $('<div/>').css({
                'margin-bottom': '5px',
                'display': 'flex',
                'gap': '5px'
            }).appendTo(displayList);
            
            $('<input/>', {
                type: 'text',
                placeholder: 'Display name (e.g., button1)',
                value: name || '',
                css: { 'flex': '1' }
            }).addClass('display-name').appendTo(row);
            
            $('<input/>', {
                type: 'text',
                placeholder: 'Display ID',
                value: id || '',
                css: { 'width': '100px' }
            }).addClass('display-id').appendTo(row);
            
            $('<button/>', {
                type: 'button',
                text: '×',
                css: { 'width': '30px' }
            }).addClass('red-ui-button').click(function() {
                row.remove();
            }).appendTo(row);
        }
        
        // Load existing mappings
        if (node.displayMappings && node.displayMappings.length > 0) {
            node.displayMappings.forEach(function(mapping) {
                addDisplayMapping(mapping.name, mapping.id);
            });
        } else {
            // Add default mappings
            ['display1', 'display2', 'display3', 'button1', 'button2'].forEach(function(name, idx) {
                addDisplayMapping(name, (idx + 1).toString());
            });
        }
        
        $("#node-input-add-display").click(function() {
            addDisplayMapping('', '');
        });
        
        // Initialize control mappings
        if (!node.controlMappings) {
            node.controlMappings = {};
        }
    },
    oneditsave: function() {
        // Save display mappings
        var displayMappings = [];
        $("#node-input-display-container > div").each(function() {
            var name = $(this).find('.display-name').val().trim();
            var id = $(this).find('.display-id').val().trim();
            if (name && id) {
                displayMappings.push({ name: name, id: id });
            }
        });
        this.displayMappings = displayMappings;
    }
});
</script>

<script type="text/html" data-template-name="nmos-is07-endpoint">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-registry"><i class="fa fa-server"></i> Registry</label>
        <input type="text" id="node-input-registry">
    </div>
    <div class="form-row">
        <label for="node-input-mqttBroker"><i class="fa fa-exchange"></i> MQTT Broker</label>
        <input type="text" id="node-input-mqttBroker" placeholder="mqtt://localhost:1883">
    </div>
    
    <hr/>
    <h4>Device Configuration</h4>
    
    <div class="form-row">
        <label for="node-input-deviceLabel"><i class="fa fa-tag"></i> Device Label</label>
        <input type="text" id="node-input-deviceLabel">
    </div>
    <div class="form-row">
        <label for="node-input-deviceDescription"><i class="fa fa-info"></i> Description</label>
        <input type="text" id="node-input-deviceDescription">
    </div>
    <div class="form-row">
        <label for="node-input-receiverLabel"><i class="fa fa-tag"></i> Receiver Label</label>
        <input type="text" id="node-input-receiverLabel">
    </div>
    
    <hr/>
    <h4>Subscription Configuration</h4>
    
    <div class="form-row">
        <label for="node-input-subscriptionFilter"><i class="fa fa-filter"></i> Subscribe Filter</label>
        <input type="text" id="node-input-subscriptionFilter" placeholder="x-nmos/events/1.0/+/+">
    </div>
    <div class="form-tip">
        <strong>Tip:</strong> Use MQTT wildcards: <code>+</code> for single level, <code>#</code> for multi-level.<br/>
        Default subscribes to all IS-07 events. For specific source: <code>x-nmos/events/1.0/{source-id}/+</code>
    </div>
    
    <hr/>
    <h4>MQTT Settings</h4>
    
    <div class="form-row">
        <label for="node-input-mqttQos"><i class="fa fa-certificate"></i> QoS Level</label>
        <select id="node-input-mqttQos">
            <option value="0">0 - At most once</option>
            <option value="1">1 - At least once</option>
            <option value="2">2 - Exactly once</option>
        </select>
    </div>
    
    <hr/>
    <h4>Endpoint Features</h4>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-sendStatusUpdates" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-sendStatusUpdates" style="width: 70%;">Send Status Updates</label>
    </div>
    <div class="form-tip">
        Enable bidirectional communication - publish status back to sources
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-parseSmartpanel" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-parseSmartpanel" style="width: 70%;">Parse RIEDEL Smartpanel Commands</label>
    </div>
    <div class="form-tip">
        Automatically parse and identify Smartpanel GPIO, button, tally, and fader commands
    </div>
    
    <hr/>
    <h4>SmartPanel Configuration</h4>
    
    <div class="form-row">
        <label for="node-input-smartpanelIp"><i class="fa fa-server"></i> SmartPanel IP</label>
        <input type="text" id="node-input-smartpanelIp" placeholder="192.168.1.100">
    </div>
    <div class="form-row">
        <label for="node-input-smartpanelPort"><i class="fa fa-plug"></i> SmartPanel Port</label>
        <input type="number" id="node-input-smartpanelPort" placeholder="8080">
    </div>
    <div class="form-tip">
        Connection settings for direct SmartPanel communication (optional)
    </div>
    
    <hr/>
    <h4>Display Mappings</h4>
    <div class="form-tip" style="margin-bottom: 10px;">
        Map friendly display names to SmartPanel display IDs for easy text updates
    </div>
    
    <div class="form-row">
        <label style="vertical-align: top;"><i class="fa fa-list"></i> Displays</label>
        <div style="display: inline-block; width: 70%;">
            <div id="node-input-display-container" style="margin-bottom: 5px;"></div>
            <button type="button" id="node-input-add-display" class="red-ui-button" style="margin-top: 5px;">
                <i class="fa fa-plus"></i> Add Display Mapping
            </button>
        </div>
    </div>
    <div class="form-tip">
        Example: Name "button1" → ID "1" allows msg.payload = {display: "button1", text: "Hello"}
    </div>
    
    <hr/>
    <h4>Resource IDs</h4>
    
    <div class="form-row">
        <label for="node-input-nodeId"><i class="fa fa-fingerprint"></i> Node ID</label>
        <input type="text" id="node-input-nodeId">
    </div>
    <div class="form-row">
        <label for="node-input-deviceId"><i class="fa fa-fingerprint"></i> Device ID</label>
        <input type="text" id="node-input-deviceId">
    </div>
    <div class="form-row">
        <label for="node-input-receiverId"><i class="fa fa-fingerprint"></i> Receiver ID</label>
        <input type="text" id="node-input-receiverId">
    </div>
    <div class="form-row">
        <label for="node-input-statusSourceId"><i class="fa fa-fingerprint"></i> Status Source ID</label>
        <input type="text" id="node-input-statusSourceId">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <button type="button" id="node-input-regenerate-ids" class="red-ui-button">
            <i class="fa fa-refresh"></i> Regenerate All IDs
        </button>
    </div>
</script>

<script type="text/html" data-help-name="nmos-is07-endpoint">
    <p>NMOS IS-07 Endpoint node - Receives control commands and tally from IS-07 sources including RIEDEL Smartpanel with comprehensive display text management.</p>
    
    <h3>Overview</h3>
    <p>This node acts as an NMOS endpoint that subscribes to IS-07 events via MQTT and processes incoming control commands. 
    It supports bidirectional communication with SmartPanel devices and provides an easy-to-use interface for display text updates.</p>
    
    <h3>Features</h3>
    <ul>
        <li><strong>IS-07 Event Subscription:</strong> Receives events from any IS-07 source</li>
        <li><strong>Easy Display Text Updates:</strong> Simple message format for updating SmartPanel displays</li>
        <li><strong>Display Name Mapping:</strong> Configure friendly names for displays (e.g., "button1", "top", "main")</li>
        <li><strong>SmartPanel Control Events:</strong> Standardized output for LeverKey and Rotary controls</li>
        <li><strong>RIEDEL Smartpanel Support:</strong> Automatic parsing of Smartpanel commands</li>
        <li><strong>Bidirectional Communication:</strong> Send status updates back to sources</li>
        <li><strong>IS-04 Registration:</strong> Registers as receiver in NMOS registry</li>
    </ul>
    
    <h3>Configuration</h3>
    
    <h4>SmartPanel Settings</h4>
    <ul>
        <li><strong>SmartPanel IP:</strong> IP address or hostname of the SmartPanel device (optional)</li>
        <li><strong>SmartPanel Port:</strong> Port for direct SmartPanel communication (optional)</li>
        <li><strong>Display Mappings:</strong> Map friendly names to SmartPanel display IDs</li>
    </ul>
    
    <h4>Device Settings</h4>
    <ul>
        <li><strong>Device Label:</strong> Display name for this endpoint</li>
        <li><strong>Receiver Label:</strong> Label for the IS-07 receiver</li>
        <li><strong>Subscription Filter:</strong> MQTT topic filter (default: all IS-07 events)</li>
    </ul>
    
    <h3>Simple Display Text Updates</h3>
    
    <h4>Single Display Update</h4>
    <p>Send text to a single display using the display name configured in mappings:</p>
    <pre>msg.payload = {
    display: "button1",
    text: "MIC 1"
};</pre>
    
    <h4>With Formatting Options</h4>
    <pre>msg.payload = {
    display: "main",
    text: "Long scrolling text message",
    scroll: true,
    align: "center",
    color: "green",
    brightness: 80
};</pre>
    
    <h4>Multiple Displays at Once</h4>
    <p>Update multiple displays with a single message:</p>
    <pre>msg.payload = {
    displays: {
        "top": "Router A",
        "middle": "Input 5",
        "bottom": "Active"
    }
};</pre>
    
    <h4>Formatting Options</h4>
    <ul>
        <li><strong>scroll:</strong> true/false - Enable text scrolling for long text</li>
        <li><strong>align:</strong> "left", "center", or "right" - Text alignment</li>
        <li><strong>color:</strong> "white", "green", "red", "amber" - Text color</li>
        <li><strong>brightness:</strong> 0-100 - Display brightness percentage</li>
    </ul>
    
    <h3>Control Event Output</h3>
    
    <p>When SmartPanel controls are activated, the node emits standardized messages:</p>
    
    <h4>LeverKey Events</h4>
    <pre>{
    topic: "smartpanel/control",
    payload: {
        event: "leverkey_up",     // or "leverkey_down"
        control: "lever1",         // control identifier
        timestamp: "2025-11-20T19:35:08Z",
        value: true,
        raw_command: {...}         // original parsed command
    }
}</pre>
    
    <h4>Rotary Control Events</h4>
    <pre>{
    topic: "smartpanel/control",
    payload: {
        event: "rotary_push",      // or "rotary_left", "rotary_right"
        control: "rotary1",        // control identifier
        timestamp: "2025-11-20T19:35:08Z",
        value: 1,
        raw_command: {...}
    }
}</pre>
    
    <h3>Action-Based Input (Advanced)</h3>
    
    <p><strong>Get Current State:</strong></p>
    <pre>msg.payload = { action: "get_state" };</pre>
    <p>Returns endpoint configuration, connection status, display mappings, and statistics.</p>
    
    <p><strong>Send Display Text (Action Format):</strong></p>
    <pre>msg.payload = {
    action: "send_display_text",
    display: "button1",         // or displayId: 1
    text: "Hello World",
    color: "green",
    brightness: 100,
    scroll: false,
    align: "left"
};</pre>
    
    <p><strong>Send Status Update:</strong></p>
    <pre>msg.payload = {
    action: "send_status",
    path: "status/ready",
    value: true
};</pre>
    
    <p><strong>Get Command History:</strong></p>
    <pre>msg.payload = { 
    action: "get_command_history",
    limit: 10
};</pre>
    
    <p><strong>Configure SmartPanel Routing:</strong></p>
    <pre>msg.payload = {
    action: "configure_smartpanel_routing",
    panelId: "panel-1",
    routingConfig: {
        source: "source-id",
        destination: "dest-id"
    }
};</pre>
    
    <h3>Output Message Format</h3>
    <p>The node outputs two types of messages:</p>
    
    <h4>1. Control Event Messages (Simplified)</h4>
    <p>Standardized messages for SmartPanel controls as shown above.</p>
    
    <h4>2. Full IS-07 Grain Messages</h4>
    <pre>{
    "topic": "x-nmos/events/1.0/{source_id}/{type}",
    "payload": {
        // IS-07 grain message
        "grain_type": "event",
        "source_id": "source-uuid",
        "grain": {...}
    },
    "smartpanel": {
        "commands": [...]  // Parsed SmartPanel commands
    }
}</pre>
    
    <h3>RIEDEL Smartpanel Command Patterns</h3>
    <p>When "Parse RIEDEL Smartpanel" is enabled, the node automatically recognizes these patterns:</p>
    <ul>
        <li><strong>GPIO:</strong> <code>gpio/input/N</code> or <code>gpi/N</code></li>
        <li><strong>Buttons:</strong> <code>button/N</code>, <code>key/N</code>, <code>switch/N</code></li>
        <li><strong>Tally:</strong> <code>tally/red</code>, <code>tally/green</code>, <code>tally/amber</code></li>
        <li><strong>Faders:</strong> <code>fader/N</code>, <code>level/N</code>, <code>gain/N</code></li>
        <li><strong>LeverKey:</strong> <code>leverkey/N/up</code>, <code>leverkey/N/down</code></li>
        <li><strong>Rotary Controls:</strong> <code>rotary/N/push</code>, <code>rotary/N/left</code>, <code>rotary/N/right</code></li>
    </ul>
    
    <h3>Integration with RIEDEL Smartpanel</h3>
    <p>To integrate with RIEDEL Smartpanel:</p>
    <ol>
        <li>Configure display mappings in the node settings (e.g., "button1" → "1")</li>
        <li>Set the MQTT broker URL to match your broker</li>
        <li>Enable "Parse RIEDEL Smartpanel Commands"</li>
        <li>Send simple display text messages: <code>{display: "button1", text: "Hello"}</code></li>
        <li>Receive standardized control events on topic "smartpanel/control"</li>
    </ol>
    
    <h3>Example Flows</h3>
    
    <h4>Update Display on Button Press</h4>
    <pre>// In a function node after the endpoint
if (msg.topic === 'smartpanel/control') {
    if (msg.payload.event === 'rotary_push') {
        return {
            payload: {
                display: msg.payload.control,
                text: "Pressed!",
                color: "green"
            }
        };
    }
}
return null;</pre>
    
    <h4>Cycle Through Menu Options</h4>
    <pre>// Handle rotary left/right to navigate menu
var menuIndex = context.get('menuIndex') || 0;
var menuItems = ['Option 1', 'Option 2', 'Option 3'];

if (msg.payload.event === 'rotary_left') {
    menuIndex = Math.max(0, menuIndex - 1);
} else if (msg.payload.event === 'rotary_right') {
    menuIndex = Math.min(menuItems.length - 1, menuIndex + 1);
}

context.set('menuIndex', menuIndex);
return {
    payload: {
        display: "main",
        text: menuItems[menuIndex]
    }
};</pre>
    
    <h3>Reference</h3>
    <ul>
        <li>NMOS IS-07: <a href="https://specs.amwa.tv/is-07/" target="_blank">specs.amwa.tv/is-07/</a></li>
        <li>RIEDEL Smartpanel: <a href="https://www.riedel.net/products/smartpanels/" target="_blank">riedel.net/products/smartpanels/</a></li>
    </ul>
</script>
