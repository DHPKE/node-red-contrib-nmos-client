<script type="text/javascript">
    RED.nodes.registerType('nmos-matrix-ui', {
        category: 'NMOS',
        color: '#CBC3E3',
        defaults: {
            name: {value: ""},
            registry: {value: "", type: "nmos-config", required: true},
            group: {value: "", type: "ui-group"},
            width: {value: 12},
            height: {value: 8}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-table",
        label: function() {
            return this.name || "NMOS Matrix";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        paletteLabel: "matrix ui"
    });
</script>

<script type="text/html" data-template-name="nmos-matrix-ui">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-registry"><i class="fa fa-server"></i> Registry</label>
        <input type="text" id="node-input-registry">
    </div>
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-th"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label for="node-input-width"><i class="fa fa-arrows-h"></i> Width</label>
        <input type="number" id="node-input-width" min="1" max="24" placeholder="12">
    </div>
    <div class="form-row">
        <label for="node-input-height"><i class="fa fa-arrows-v"></i> Height</label>
        <input type="number" id="node-input-height" min="1" max="24" placeholder="8">
    </div>
</script>

<script type="text/html" data-help-name="nmos-matrix-ui">
    <p>Visual NMOS sender-receiver routing matrix for Node-RED Dashboard 2.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">string</span></dt>
        <dd>Optional name for the node</dd>
        
        <dt>Registry <span class="property-type">nmos-config</span></dt>
        <dd>NMOS registry configuration (required)</dd>
        
        <dt>Group <span class="property-type">ui-group</span></dt>
        <dd>Dashboard 2 UI group to display the matrix</dd>
        
        <dt>Width <span class="property-type">number</span></dt>
        <dd>Widget width in Dashboard grid units (1-24, default: 12)</dd>
        
        <dt>Height <span class="property-type">number</span></dt>
        <dd>Widget height in Dashboard grid units (1-24, default: 8)</dd>
    </dl>
    
    <h3>Features</h3>
    <ul>
        <li><strong>Interactive Matrix Grid:</strong> Visualize all senders (columns) and receivers (rows)</li>
        <li><strong>Click to Connect:</strong> Click any crosspoint to toggle connection</li>
        <li><strong>Active Connections:</strong> Currently active connections highlighted in teal (#3FADB5)</li>
        <li><strong>Search/Filter:</strong> Real-time filtering for senders and receivers</li>
        <li><strong>Refresh:</strong> Reload resources and connections from registry</li>
        <li><strong>Sticky Headers:</strong> Scrollable matrix with fixed headers for easy navigation</li>
        <li><strong>Status Bar:</strong> Shows sender/receiver counts and loading state</li>
    </ul>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload.action <span class="property-type">string</span></dt>
        <dd>Action to perform:
            <ul>
                <li><code>"route"</code> - Trigger routing operation</li>
                <li><code>"refresh"</code> - Reload resources from registry</li>
            </ul>
        </dd>
        
        <dt class="optional">payload.receiverId <span class="property-type">string</span></dt>
        <dd>Receiver UUID (required for route action)</dd>
        
        <dt class="optional">payload.senderId <span class="property-type">string</span></dt>
        <dd>Sender UUID (null to disconnect)</dd>
        
        <dt class="optional">payload.operation <span class="property-type">string</span></dt>
        <dd>Operation type: <code>"activate"</code> or <code>"disconnect"</code></dd>
    </dl>
    
    <h3>Outputs</h3>
    <p>Outputs routing messages compatible with the <code>nmos-connection</code> node:</p>
    <dl class="message-properties">
        <dt>receiverId <span class="property-type">string</span></dt>
        <dd>Receiver UUID</dd>
        
        <dt>senderId <span class="property-type">string</span></dt>
        <dd>Sender UUID (null for disconnect)</dd>
        
        <dt>operation <span class="property-type">string</span></dt>
        <dd>Operation type: <code>"activate"</code> or <code>"disconnect"</code></dd>
    </dl>
    
    <h3>Usage Example</h3>
    <p>Connect the matrix UI to an <code>nmos-connection</code> node to enable routing:</p>
    <pre>[nmos-matrix-ui] → [nmos-connection] → [debug]</pre>
    
    <h3>Matrix Interaction</h3>
    <ul>
        <li><strong>Connect:</strong> Click an empty crosspoint to connect the sender to the receiver</li>
        <li><strong>Disconnect:</strong> Click an active crosspoint (teal) to disconnect</li>
        <li><strong>Search:</strong> Use the search boxes to filter senders and receivers by label</li>
        <li><strong>Scroll:</strong> The matrix supports scrolling for large numbers of senders/receivers</li>
        <li><strong>Refresh:</strong> Click the refresh button to reload resources and update connection status</li>
    </ul>
    
    <h3>Requirements</h3>
    <ul>
        <li>Node-RED Dashboard 2 (<code>@flowfuse/node-red-dashboard</code>)</li>
        <li>Configured NMOS registry (<code>nmos-config</code> node)</li>
        <li>Optional: <code>nmos-connection</code> node for automatic routing</li>
    </ul>
    
    <h3>Notes</h3>
    <ul>
        <li>The matrix retrieves senders and receivers from the NMOS registry via IS-04 Query API</li>
        <li>Active connections are determined by querying receiver subscription information</li>
        <li>Routing operations are output as messages - connect to <code>nmos-connection</code> for IS-05 routing</li>
        <li>The matrix supports up to 500 senders and 500 receivers for performance</li>
        <li>Connection state updates may take a few seconds to reflect after routing operations</li>
    </ul>
</script>


